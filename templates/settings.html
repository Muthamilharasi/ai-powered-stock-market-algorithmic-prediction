{% extends "base.html" %}

{% block title %}Settings - CashOnDay{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>Settings</h1>
            <p class="text-muted">Manage your account preferences and integrations</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-3 mb-4">
            <!-- Settings Navigation -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Settings</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#notifications" class="list-group-item list-group-item-action active" onclick="showSection('notifications')">
                        <i data-feather="bell"></i>
                        Notifications
                    </a>
                    <a href="#telegram" class="list-group-item list-group-item-action" onclick="showSection('telegram')">
                        <i data-feather="message-circle"></i>
                        Telegram Integration
                    </a>
                    <a href="#appearance" class="list-group-item list-group-item-action" onclick="showSection('appearance')">
                        <i data-feather="monitor"></i>
                        Appearance
                    </a>
                    <a href="#privacy" class="list-group-item list-group-item-action" onclick="showSection('privacy')">
                        <i data-feather="shield"></i>
                        Privacy & Security
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            <!-- Notifications Settings -->
            <div id="notifications-section" class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Notification Preferences</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Email Notifications</h6>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="email_notifications" 
                                               id="emailNotifications" {% if settings.email_notifications %}checked{% endif %}>
                                        <label class="form-check-label" for="emailNotifications">
                                            Enable email notifications
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>Telegram Notifications</h6>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="telegram_notifications" 
                                               id="telegramNotifications" {% if settings.telegram_notifications %}checked{% endif %}>
                                        <label class="form-check-label" for="telegramNotifications">
                                            Enable Telegram notifications
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Alert Types</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="price_alerts" 
                                               id="priceAlerts" {% if settings.price_alerts %}checked{% endif %}>
                                        <label class="form-check-label" for="priceAlerts">
                                            Price alerts
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="news_alerts" 
                                               id="newsAlerts" {% if settings.news_alerts %}checked{% endif %}>
                                        <label class="form-check-label" for="newsAlerts">
                                            News sentiment alerts
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>Trading Notifications</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="tradeExecutions" checked>
                                        <label class="form-check-label" for="tradeExecutions">
                                            Trade executions
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="portfolioUpdates" checked>
                                        <label class="form-check-label" for="portfolioUpdates">
                                            Portfolio updates
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Save Notification Settings</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Telegram Integration -->
            <div id="telegram-section" class="settings-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Telegram Integration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Setup Instructions</h6>
                                <ol>
                                    <li>Open Telegram and search for <code>@CashOnDayBot</code></li>
                                    <li>Start a conversation with the bot by clicking "Start"</li>
                                    <li>The bot will send you your Chat ID</li>
                                    <li>Copy the Chat ID and paste it below</li>
                                </ol>
                                
                                <form method="POST" class="mt-3">
                                    <div class="mb-3">
                                        <label for="telegramChatId" class="form-label">Telegram Chat ID</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="telegram_chat_id" 
                                                   id="telegramChatId" value="{{ user.telegram_chat_id or '' }}" 
                                                   placeholder="Enter your Chat ID">
                                            <button class="btn btn-outline-secondary" type="button" onclick="testTelegram()">
                                                Test Connection
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">
                                            Your Chat ID should look like: 123456789
                                        </small>
                                    </div>
                                    
                                    <div class="telegram-status mb-3" id="telegramStatus">
                                        {% if user.telegram_chat_id %}
                                        <div class="alert alert-success">
                                            <i data-feather="check-circle"></i>
                                            Telegram integration is active
                                        </div>
                                        {% else %}
                                        <div class="alert alert-warning">
                                            <i data-feather="alert-triangle"></i>
                                            Telegram integration not configured
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">Save Telegram Settings</button>
                                </form>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i data-feather="smartphone" size="48" class="text-primary mb-3"></i>
                                        <h6>Benefits of Telegram Integration</h6>
                                        <ul class="list-unstyled text-start">
                                            <li><i data-feather="check" width="16"></i> Real-time price alerts</li>
                                            <li><i data-feather="check" width="16"></i> Trade notifications</li>
                                            <li><i data-feather="check" width="16"></i> Portfolio updates</li>
                                            <li><i data-feather="check" width="16"></i> News sentiment alerts</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Appearance Settings -->
            <div id="appearance-section" class="settings-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Appearance</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Theme</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="theme" id="lightTheme" 
                                               value="light" {% if settings.theme == 'light' %}checked{% endif %}>
                                        <label class="form-check-label" for="lightTheme">
                                            <i data-feather="sun"></i> Light Theme
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="theme" id="darkTheme" 
                                               value="dark" {% if settings.theme == 'dark' %}checked{% endif %}>
                                        <label class="form-check-label" for="darkTheme">
                                            <i data-feather="moon"></i> Dark Theme
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="theme" id="autoTheme" 
                                               value="auto" {% if settings.theme == 'auto' %}checked{% endif %}>
                                        <label class="form-check-label" for="autoTheme">
                                            <i data-feather="monitor"></i> Auto (System)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>Dashboard Layout</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="compactMode">
                                        <label class="form-check-label" for="compactMode">
                                            Compact mode
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="animationsEnabled" checked>
                                        <label class="form-check-label" for="animationsEnabled">
                                            Enable animations
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                        <label class="form-check-label" for="autoRefresh">
                                            Auto-refresh data
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Save Appearance Settings</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Privacy & Security -->
            <div id="privacy-section" class="settings-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Privacy & Security</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Data Privacy</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="dataCollection" checked>
                                    <label class="form-check-label" for="dataCollection">
                                        Allow anonymous usage analytics
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="marketingEmails">
                                    <label class="form-check-label" for="marketingEmails">
                                        Receive marketing emails
                                    </label>
                                </div>
                                
                                <h6>Session Management</h6>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="rememberDevice" checked>
                                    <label class="form-check-label" for="rememberDevice">
                                        Remember this device for 30 days
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Account Security</h6>
                                <div class="mb-3">
                                    <p class="text-muted">Last login: {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</p>
                                    <p class="text-muted">Account created: {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'Unknown' }}</p>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('profile') }}" class="btn btn-outline-primary">
                                        <i data-feather="edit"></i> Change Password
                                    </a>
                                    <button class="btn btn-outline-warning" onclick="clearSessions()">
                                        <i data-feather="log-out"></i> Clear All Sessions
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteAccount()">
                                        <i data-feather="trash-2"></i> Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                

<script>
function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.settings-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Remove active class from all nav items
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionName + '-section').style.display = 'block';
    
    // Add active class to clicked nav item
    event.target.classList.add('active');
}

async function testTelegram() {
    const chatId = document.getElementById('telegramChatId').value;
    
    if (!chatId) {
        showAlert('warning', 'Please enter your Telegram Chat ID first');
        return;
    }
    
    try {
        const response = await fetch('/api/test-telegram', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ chat_id: chatId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Test message sent! Check your Telegram.');
            updateTelegramStatus(true);
        } else {
            showAlert('danger', 'Failed to send test message. Please check your Chat ID.');
            updateTelegramStatus(false);
        }
    } catch (error) {
        showAlert('danger', 'Error testing Telegram connection');
        updateTelegramStatus(false);
    }
}

function updateTelegramStatus(isActive) {
    const statusDiv = document.getElementById('telegramStatus');
    
    if (isActive) {
        statusDiv.innerHTML = `
            <div class="alert alert-success">
                <i data-feather="check-circle"></i>
                Telegram integration is active
            </div>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i data-feather="x-circle"></i>
                Telegram integration failed
            </div>
        `;
    }
    
    feather.replace();
}

function clearSessions() {
    if (confirm('This will log you out from all devices. Continue?')) {
        // Implement session clearing
        window.location.href = '/logout';
    }
}

function deleteAccount() {
    if (confirm('This will permanently delete your account and all data. This action cannot be undone. Are you sure?')) {
        const password = prompt('Please enter your password to confirm account deletion:');
        if (password) {
            // Implement account deletion
            showAlert('warning', 'Account deletion functionality will be implemented');
        }
    }
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Theme switching
document.querySelectorAll('input[name="theme"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            applyTheme(this.value);
        }
    });
});

function applyTheme(theme) {
    // Theme switching logic would be implemented here
    document.body.className = theme === 'dark' ? 'theme-dark' : 'theme-light';
}

// Initialize with current theme
document.addEventListener('DOMContentLoaded', function() {
    const currentTheme = '{{ settings.theme }}' || 'light';
    applyTheme(currentTheme);
});
</script>
{% endblock %}
