{% extends "base.html" %}

{% block title %}Alerts - CashOnDay{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>Price Alerts</h1>
                    <p class="text-muted">Set up custom price alerts for your favorite stocks</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAlertModal">
                    <i data-feather="plus"></i>
                    Create Alert
                </button>
            </div>
        </div>
    </div>
    
    <!-- Alert Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon bg-primary">
                    <i data-feather="bell"></i>
                </div>
                <div class="stats-content">
                    <h3 id="totalAlerts">{{ alerts|length }}</h3>
                    <p>Total Alerts</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon bg-success">
                    <i data-feather="check-circle"></i>
                </div>
                <div class="stats-content">
                    <h3 id="activeAlerts">{{ alerts|selectattr("status", "equalto", "Active")|list|length }}</h3>
                    <p>Active Alerts</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon bg-warning">
                    <i data-feather="zap"></i>
                </div>
                <div class="stats-content">
                    <h3 id="triggeredAlerts">{{ alerts|selectattr("status", "equalto", "Triggered")|list|length }}</h3>
                    <p>Triggered</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="stats-icon bg-info">
                    <i data-feather="trending-up"></i>
                </div>
                <div class="stats-content">
                    <h3 id="watchedStocks">{{ alerts|map(attribute='symbol')|unique|list|length }}</h3>
                    <p>Watched Stocks</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Alert Setup -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Alert Setup</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="quickSymbol" class="form-label">Stock Symbol</label>
                            <input type="text" class="form-control" id="quickSymbol" placeholder="e.g., AAPL">
                        </div>
                        <div class="col-md-3">
                            <label for="quickCondition" class="form-label">Condition</label>
                            <select class="form-select" id="quickCondition">
                                <option value=">">Price Above</option>
                                <option value="<">Price Below</option>
                                <option value=">=">Price Above or Equal</option>
                                <option value="<=">Price Below or Equal</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="quickPrice" class="form-label">Target Price</label>
                            <input type="number" class="form-control" id="quickPrice" step="0.01" placeholder="0.00">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="createQuickAlert()">
                                <i data-feather="plus"></i>
                                Create Alert
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alerts List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your Alerts</h5>
                    <div class="alert-filters">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary active" onclick="filterAlerts('all')">All</button>
                            <button class="btn btn-outline-success" onclick="filterAlerts('Active')">Active</button>
                            <button class="btn btn-outline-warning" onclick="filterAlerts('Triggered')">Triggered</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if alerts %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="alertsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Condition</th>
                                    <th>Current Price</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Triggered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in alerts %}
                                <tr data-status="{{ alert.status }}" data-alert-id="{{ alert.id }}">
                                    <td><strong>{{ alert.symbol }}</strong></td>
                                    <td>
                                        <code>{{ alert.condition }}</code>
                                    </td>
                                    <td>
                                        <span class="current-price" data-symbol="{{ alert.symbol }}">Loading...</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if alert.status == 'Active' %}success{% elif alert.status == 'Triggered' %}warning{% else %}secondary{% endif %}">
                                            {{ alert.status }}
                                        </span>
                                    </td>
                                    <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') if alert.created_at else 'Unknown' }}</td>
                                    <td>{{ alert.triggered_at.strftime('%Y-%m-%d %H:%M') if alert.triggered_at else '-' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if alert.status == 'Active' %}
                                            <button class="btn btn-outline-secondary" onclick="pauseAlert({{ alert.id }})">
                                                <i data-feather="pause"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary" onclick="editAlert({{ alert.id }})">
                                                <i data-feather="edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteAlert({{ alert.id }})">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i data-feather="bell-off" size="64" class="text-muted mb-3"></i>
                        <h4>No Alerts Set</h4>
                        <p class="text-muted">Create your first price alert to get notified when stocks hit your target prices</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAlertModal">
                            <i data-feather="plus"></i>
                            Create Your First Alert
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Alert Modal -->
<div class="modal fade" id="createAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAlertForm">
                    <div class="mb-3">
                        <label for="alertSymbol" class="form-label">Stock Symbol</label>
                        <input type="text" class="form-control" id="alertSymbol" required 
                               placeholder="e.g., AAPL, TSLA, MSFT">
                        <small class="form-text text-muted">Enter the stock symbol you want to track</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alertCondition" class="form-label">Alert Condition</label>
                        <div class="row">
                            <div class="col-6">
                                <select class="form-select" id="alertOperator" required>
                                    <option value="">Select condition</option>
                                    <option value=">">Price above</option>
                                    <option value="<">Price below</option>
                                    <option value=">=">Price above or equal</option>
                                    <option value="<=">Price below or equal</option>
                                    <option value="==">Price equals</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" id="alertPrice" step="0.01" 
                                       placeholder="Target price" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notification Methods</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailNotification" checked>
                            <label class="form-check-label" for="emailNotification">
                                Email notification
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="telegramNotification" 
                                   {% if user.telegram_chat_id %}checked{% else %}disabled{% endif %}>
                            <label class="form-check-label" for="telegramNotification">
                                Telegram notification
                                {% if not user.telegram_chat_id %}
                                <small class="text-muted">(Configure in Settings)</small>
                                {% endif %}
                            </label>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i data-feather="info"></i>
                        <strong>Example:</strong> Set "AAPL Price above 150.00" to get notified when Apple stock rises above $150
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateAlert()">
                    <i data-feather="bell"></i>
                    Create Alert
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Load current prices for alerts
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentPrices();
    // Refresh prices every 30 seconds
    setInterval(loadCurrentPrices, 30000);
});

async function loadCurrentPrices() {
    const priceElements = document.querySelectorAll('.current-price');
    
    for (const element of priceElements) {
        const symbol = element.dataset.symbol;
        try {
            const response = await fetch(`/api/stock-data/${symbol}`);
            const data = await response.json();
            
            if (response.ok) {
                const changeClass = data.price_change >= 0 ? 'text-success' : 'text-danger';
                element.innerHTML = `
                    <span class="${changeClass}">$${data.current_price}</span>
                `;
            } else {
                element.textContent = 'Error';
            }
        } catch (error) {
            element.textContent = 'Error';
        }
    }
}

function createQuickAlert() {
    const symbol = document.getElementById('quickSymbol').value.trim();
    const condition = document.getElementById('quickCondition').value;
    const price = document.getElementById('quickPrice').value;
    
    if (!symbol || !price) {
        showAlert('warning', 'Please fill in all fields');
        return;
    }
    
    const conditionString = `Price ${condition} ${price}`;
    createAlert(symbol.toUpperCase(), conditionString);
}

function submitCreateAlert() {
    const symbol = document.getElementById('alertSymbol').value.trim();
    const operator = document.getElementById('alertOperator').value;
    const price = document.getElementById('alertPrice').value;
    
    if (!symbol || !operator || !price) {
        showAlert('warning', 'Please fill in all fields');
        return;
    }
    
    const conditionString = `Price ${operator} ${price}`;
    createAlert(symbol.toUpperCase(), conditionString);
}

async function createAlert(symbol, condition) {
    try {
        const response = await fetch('/api/create-alert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                condition: condition
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `Alert created for ${symbol}!`);
            // Close modal if open
            const modal = bootstrap.Modal.getInstance(document.getElementById('createAlertModal'));
            if (modal) modal.hide();
            
            // Reset forms
            document.getElementById('createAlertForm').reset();
            document.getElementById('quickSymbol').value = '';
            document.getElementById('quickPrice').value = '';
            
            // Reload page to show new alert
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', `Failed to create alert: ${result.error}`);
        }
    } catch (error) {
        showAlert('danger', 'Error creating alert. Please try again.');
    }
}

async function deleteAlert(alertId) {
    if (!confirm('Are you sure you want to delete this alert?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/delete-alert/${alertId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Alert deleted successfully');
            // Remove the row from table
            const row = document.querySelector(`tr[data-alert-id="${alertId}"]`);
            if (row) row.remove();
            
            // Update statistics
            updateAlertStats();
        } else {
            showAlert('danger', 'Failed to delete alert');
        }
    } catch (error) {
        showAlert('danger', 'Error deleting alert');
    }
}

function pauseAlert(alertId) {
    // Implement pause functionality
    showAlert('info', 'Pause functionality will be implemented');
}

function editAlert(alertId) {
    // Implement edit functionality
    showAlert('info', 'Edit functionality will be implemented');
}

function filterAlerts(status) {
    const rows = document.querySelectorAll('#alertsTable tbody tr');
    const buttons = document.querySelectorAll('.alert-filters .btn');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter rows
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function updateAlertStats() {
    const rows = document.querySelectorAll('#alertsTable tbody tr');
    const totalAlerts = rows.length;
    const activeAlerts = document.querySelectorAll('tr[data-status="Active"]').length;
    const triggeredAlerts = document.querySelectorAll('tr[data-status="Triggered"]').length;
    
    document.getElementById('totalAlerts').textContent = totalAlerts;
    document.getElementById('activeAlerts').textContent = activeAlerts;
    document.getElementById('triggeredAlerts').textContent = triggeredAlerts;
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Auto-suggest symbols for quick alert
document.getElementById('quickSymbol').addEventListener('input', function() {
    // Implement auto-complete functionality
    this.value = this.value.toUpperCase();
});

document.getElementById('alertSymbol').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});
</script>
{% endblock %}
